@using SonodaSoftware.Data
@{
    ViewData["Title"] = "PartSearch";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["activeJobmanage"] = "active";
    ViewData["activePartsearchJob"] = "active";
    ViewData["openJob"] = "menu-open";
    var part = ViewData["part"] as List<Job_Part_inStore>;
    var jobMap = ViewData["jobMap"] as Dictionary<int, string>;
}

<main class="content">
    <form id="Partsearch">
        <div class="my-3">
            <label id="labelSearchBy"></label>
            <select id="SearchBy" name="SearchBy">
                <option>Barcode</option>
                <option>PartNameEng</option>
                <option>PartNameThai</option>
                <option>Job</option>
            </select>
        </div>
        <div class="card">
            <div class="card-body text-center">
                <input id="keyword" name="keyword" class="form-control my-3" />
                <button id="search" class="btn btn-primary">Search</button>
            </div>
        </div>
    </form>
    <div id="tabledataEng" class="card">
        <div class="card-body">
            <table id="tableEng" class="table">
                <thead>
                    <tr>
                        <th hidden>ID</th>
                        <th>Barcode</th>
                        <th>PartNameEng</th>
                        <th>PartNameThai</th>
                        <th hidden>JobID</th>
                        <th>Job</th>
                        <th>Quantity</th>
                        <th>Location</th>
                        <th hidden>CreateOn</th>
                        <th hidden>ModifyOn</th>
                        <th>RRNo</th>
                        <th>PONo</th>
                        <th>Edit</th>
                    </tr>
                </thead>
                <tbody>
                    @if (part != null)
                    {
                        foreach (var item in part)
                        {
                            <tr>
                                <td hidden>@item.ID</td>
                                <td>@item.Barcode</td>
                                <td>@item.PartNameEng</td>
                                <td>@item.PartNameThai</td>
                                <td hidden>@item.JobID</td>
                                <td>@(jobMap != null && jobMap.ContainsKey(item.JobID ?? 0) ? jobMap[item.JobID.Value] : "N/A")</td>
                                <td>@item.Quantity</td>
                                <td>@item.Location</td>
                                <td hidden>@item.CreateOn</td>
                                <td hidden>@item.ModifyOn</td>
                                <td>@item.PrNo</td>
                                <td>@item.PONo</td>
                                <td><button class=" btn btn-secondary" onclick="EditPart(@item.ID)">Edit</button></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</main>

<!--Modal EditPart-->
<div class="modal fade" id="ModalEditPart" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <label class="h3">Edit Part</label><br />
                <button onclick="closeModal('#ModalEditPart')" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <div class="card">
                    <div class="card-body row row-cols-2">
                        <label class="px-2">Barcode  <input class="form-control" required id="Barcode" /></label>
                        <label class="px-2">PartNameEng <input class="form-control" id="PartNameEng" /></label>
                        <label class="px-2">PartNameThai <input class="form-control" id="PartNameThai" /></label>
                        <label class="px-2">JobID <input class="form-control" id="JobID" /></label>
                        <label class="px-2">Quantity <input class="form-control" id="Quantity" /></label>
                        <label class="px-2">Location <input class="form-control" id="Location" /></label>
                        <label class="px-2">RRNo <input class="form-control" id="PrNo" /></label>
                        <label class="px-2">PONo <input class="form-control" id="PONo" /></label>
                    </div>
                </div>
                <button onclick="SaveEdit()" class="btn btn-primary form-control mt-2">Save</button>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script>
        var IDPart;
        if ('@TempData["AddPart"]' != "") {
            alert('@TempData["AddPart"]');
        }
        var select = document.getElementById('SearchBy')
        var table = new DataTable('#tableEng', {
            scrollX: true,
            autoWidth: false,
            pageLength: 7
                    dom: 'Bfrtip', // เพิ่มสำหรับแสดงปุ่ม
            buttons: [
                {
                    extend: 'csvHtml5',
                    text: 'Export CSV',
                    className: 'btn btn-sm btn-outline-primary'
                },
                {
                    extend: 'excelHtml5',
                    text: 'Export Excel',
                    className: 'btn btn-sm btn-outline-success'
                }
            ]
        });
        var searchby = sessionStorage.getItem("select");

         $("#SearchBy option").each(function () {
            if ($(this).text() == searchby)
                $(this).attr("selected", "selected");
        });

        $("#SearchBy").change(function () {
            sessionStorage.setItem("select", $(this).find(":selected").text())
        });

        $("#search").on('click', function () {
            $("#Partsearch").attr('action', '/Job/Partsearchresult');
        });

        var partList = @Html.Raw(Json.Serialize(ViewData["part"]));

        function EditPart(ID) {
            const part = partList.find(p => p.id === ID);
            if (part) {
                $('#ModalEditPart').modal('show');
                $('#Barcode').val(part.barcode);
                $('#PartNameEng').val(part.partNameEng);
                $('#PartNameThai').val(part.partNameThai);
                $('#JobID').val(part.jobID);
                $('#Quantity').val(part.quantity);
                $('#Location').val(part.location);
                $('#PrNo').val(part.prNo);
                $('#PONo').val(part.poNo);
            } else {
                alert("ไม่พบ Part ที่ต้องการแก้ไข");
            }
        }

        function closeModal(modal) {
            $(modal).modal('hide');
        }

         function SaveEdit() {
            var JobPart = {
                ID: IDPart, // ต้องมั่นใจว่า IDPart ถูกกำหนดใน EditPart()
                Barcode: $("#Barcode").val(),
                PartNameEng: $("#PartNameEng").val(),
                PartNameThai: $("#PartNameThai").val(),
                JobID: $("#JobID").val(),
                Quantity: $("#Quantity").val(),
                Location: $("#Location").val(),
                PrNo: $("#PrNo").val(),
                PONo: $("#PONo").val()
            };

            $.post("/Job/SaveEditpart", JobPart, function (data) {
                if (data.success) {
                    alert("บันทึกสำเร็จ");
                    location.reload(); // หรือรีเฟรชเฉพาะส่วนที่จำเป็น
                } else {
                    alert("ผิดพลาด: " + data.message);
                }
            }).fail(function () {
                alert("เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์");
            });
        }


    </script>
}
